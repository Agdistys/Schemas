<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galerie – Agdistys</title>
  <style>
    :root { --w: 1200px; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;padding:24px;display:grid;place-items:start center;background:#111;color:#eee}
    main{width:100%;max-width:var(--w)}
    h1{margin:0 0 12px;font-size:24px}
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .pill, .control a{border:1px solid #444;border-radius:999px;padding:6px 10px;font-size:13px;background:#222;color:#eee;text-decoration:none}
    .pill:hover,.control a:hover{background:#333}
    .control{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 18px}
    select{background:#222;color:#eee;border:1px solid #444;border-radius:10px;padding:6px 10px}
    label{font-size:13px;opacity:.9}
    .sec{margin:28px 0}
    .sec h2{margin:0 0 10px;font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{border:1px solid #444;border-radius:12px;overflow:hidden;background:#1a1a1a;box-shadow:0 1px 2px rgba(0,0,0,.4)}
    .thumb{width:100%;height:200px;object-fit:contain;background:#000;display:block}
    .cap{font-size:12px;padding:6px 8px;color:#ccc;word-break:break-word}
    .empty{opacity:.7;font-size:14px;padding:4px 0 0 2px}
    .err{color:#f88;font-size:13px;white-space:pre-wrap;padding:4px 0 0 2px}
    footer{margin:40px 0 10px;font-size:12px;opacity:.7}
    .hidden{display:none}
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <h1>Galerie – Agdistys</h1>
      <span class="pill">CC BY-SA 4.0</span>
      <a class="pill" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">Licence</a>
      <a class="pill" href="https://github.com/Agdistys/Schemas" target="_blank" rel="noopener">Dépôt GitHub</a>
    </div>

    <!-- Contrôles -->
    <div class="control">
      <label for="folderSel">Aller au dossier :</label>
      <select id="folderSel">
        <option value="">— (tout) —</option>
      </select>
      <label><input type="checkbox" id="isolateChk"> Isoler ce dossier</label>
      <a href="#" id="resetView">Réinitialiser</a>
    </div>

    <div id="gallery"></div>

    <footer>
      © Diane Serant (Agdistys) — ConScience aMi : Vérité = Respect, Mensonge = Violence ·
      Sitemap images : <a href="https://agdistys.github.io/Schemas/sitemap.xml" target="_blank" rel="noopener" style="color:#9cf">ouvrir</a>
    </footer>
  </main>

  <script>
    const OWNER="Agdistys", REPO="Schemas";
    const IMAGE_EXT=["png","jpg","jpeg","webp","gif","svg"];
    const apiBase=`https://api.github.com/repos/${OWNER}/${REPO}/contents`;

    const params=new URLSearchParams(location.search);
    const PARAM_DIR=(params.get("dir")||"").trim();

    function isImage(n){const e=n.split(".").pop().toLowerCase();return IMAGE_EXT.includes(e)}
    function urlFor(p){return p.split("/").map(encodeURI).join("/")}

    async function list(path=""){
      const url=`${apiBase}/${path?encodeURIComponent(path):""}`;
      const res=await fetch(url,{headers:{"Accept":"application/vnd.github.v3+json"}});
      if(!res.ok) throw new Error(`${path||"Racine"} → ${res.status} ${res.statusText}`);
      return res.json();
    }

    function section(title,id){
      const s=document.createElement("section"); s.className="sec"; s.dataset.section=id;
      s.innerHTML=`<h2 id="${encodeURIComponent(id)}">${title}</h2><div class="grid"></div>`;
      return s;
    }

    function addOption(sel, text, value){
      const o=document.createElement("option"); o.textContent=text; o.value=value; sel.appendChild(o);
    }

    function scrollToId(id){
      const el=document.getElementById(encodeURIComponent(id));
      if(el){ el.scrollIntoView({behavior:"smooth", block:"start"}); }
    }

    function isolateSection(id, on){
      document.querySelectorAll(".sec").forEach(sec=>{
        const match = (sec.dataset.section===id) || (id==="" && sec.dataset.section==="Racine");
        sec.classList.toggle("hidden", on && !match);
      });
    }

    async function renderDir(root, dir){
      const sec=section(dir, dir); root.appendChild(sec);
      const grid=sec.querySelector(".grid");
      try{
        const items=await list(dir);
        const imgs=items.filter(x=>x.type==="file" && isImage(x.name));
        if(imgs.length===0){ grid.innerHTML=`<div class="empty">Aucune image trouvée ici</div>`; return; }
        for(const f of imgs){
          const url=urlFor(f.path);
          const card=document.createElement("div"); card.className="card";
          card.innerHTML=`<a href="${url}" target="_blank" rel="noopener">
            <img class="thumb" loading="lazy" src="${url}" alt="${f.name}">
            <div class="cap">${f.name}</div></a>`;
          grid.appendChild(card);
        }
      }catch(e){ grid.innerHTML=`<div class="err">Erreur de listing [${dir}] : ${e.message}</div>`; }
    }

    async function renderAll(){
      const root=document.getElementById("gallery");
      root.innerHTML="";

      // Liste racine
      let entries;
      try{ entries=await list(""); }catch(e){
        const err=document.createElement("div"); err.className="err";
        err.textContent="Erreur de listing racine : "+e.message; root.appendChild(err); return;
      }
      const dirs=entries.filter(x=>x.type==="dir").map(x=>x.name);
      const files=entries.filter(x=>x.type==="file" && isImage(x.name));

      // Remplir le menu
      const sel=document.getElementById("folderSel");
      sel.innerHTML=""; addOption(sel,"— (tout) —","");
      if(files.length) addOption(sel,"Racine","Racine");
      dirs.forEach(d=>addOption(sel,d,d));

      // Section Racine
      if(files.length){
        const sec=section("Racine","Racine"); const grid=sec.querySelector(".grid");
        for(const f of files){
          const url=urlFor(f.path);
          const card=document.createElement("div"); card.className="card";
          card.innerHTML=`<a href="${url}" target="_blank" rel="noopener">
            <img class="thumb" loading="lazy" src="${url}" alt="${f.name}">
            <div class="cap">${f.name}</div></a>`;
          grid.appendChild(card);
        }
        root.appendChild(sec);
      }

      // Dossiers
      for(const d of dirs){ await renderDir(root,d); }

      // Pré-sélection via ?dir=…
      const isolateChk=document.getElementById("isolateChk");
      if(PARAM_DIR){
        sel.value = PARAM_DIR;
        isolateChk.checked = true;
        isolateSection(PARAM_DIR, true);
        scrollToId(PARAM_DIR);
      }

      // Événements UI
      sel.addEventListener("change", ()=>{
        const id = sel.value;
        if(document.getElementById("isolateChk").checked){
          isolateSection(id || "Racine", true);
        } else {
          isolateSection("", false);
          if(id) scrollToId(id);
          else window.scrollTo({top:0, behavior:"smooth"});
        }
      });
      isolateChk.addEventListener("change", ()=>{
        const id = sel.value || "Racine";
        isolateSection(id, isolateChk.checked);
      });
      document.getElementById("resetView").addEventListener("click",(e)=>{
        e.preventDefault();
        sel.value=""; isolateChk.checked=false; isolateSection("", false);
        window.scrollTo({top:0, behavior:"smooth"});
        history.replaceState(null, "", location.pathname); // retire ?dir
      });
    }

    renderAll();
  </script>
</body>
</html>
